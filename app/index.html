<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1e293b">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Worklist">
  <meta name="description" content="Offline-first task management. No account required.">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Worklist â€” Offline-First Task Management</title>
  <script src="./react.production.min.js"></script>
  <script src="./react-dom.production.min.js"></script>
  <script src="./babel.min.js"></script>
  <style>
    /* Tailwind-like utilities - full subset for offline use */
    *, *::before, *::after { box-sizing: border-box; }
    * { margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .content-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .content-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; }
    .drag-over { background-color: #3b82f6 !important; opacity: 0.7; }

    /* Layout */
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .flex-1 { flex: 1; }
    .flex-wrap { flex-wrap: wrap; }
    .items-center { align-items: center; }
    .items-end { align-items: flex-end; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-0\.5 { gap: 0.125rem; }
    .gap-1 { gap: 0.25rem; }
    .gap-1\.5 { gap: 0.375rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-2\.5 { gap: 0.625rem; }
    .gap-3 { gap: 0.75rem; }
    .overflow-hidden { overflow: hidden; }
    .overflow-auto { overflow: auto; }
    .overflow-x-auto { overflow-x: auto; }
    .overflow-y-auto { overflow-y: auto; }
    .flex-shrink-0 { flex-shrink: 0; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .whitespace-nowrap { white-space: nowrap; }
    .min-w-3 { min-width: 0.75rem; }

    /* Sizing */
    .h-screen { height: 100vh; }
    .h-full { height: 100%; }
    .w-full { width: 100%; }
    .w-8 { width: 2rem; }
    .w-20 { width: 5rem; }
    .w-52 { width: 13rem; }
    .w-16 { width: 4rem; }
    .w-1\.5 { width: 0.375rem; }
    .w-2 { width: 0.5rem; }
    .w-2\.5 { width: 0.625rem; }
    .w-3 { width: 0.75rem; }
    .w-3\.5 { width: 0.875rem; }
    .h-1\.5 { height: 0.375rem; }
    .h-2 { height: 0.5rem; }
    .h-2\.5 { height: 0.625rem; }
    .h-3 { height: 0.75rem; }
    .h-3\.5 { height: 0.875rem; }
    .h-16 { height: 4rem; }
    .max-w-20 { max-width: 5rem; }
    .max-w-sm { max-width: 24rem; }
    .max-w-md { max-width: 28rem; }

    /* Spacing */
    .p-0\.5 { padding: 0.125rem; }
    .p-1 { padding: 0.25rem; }
    .p-1\.5 { padding: 0.375rem; }
    .p-2 { padding: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .p-6 { padding: 1.5rem; }
    .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
    .px-1\.5 { padding-left: 0.375rem; padding-right: 0.375rem; }
    .px-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
    .px-2\.5 { padding-left: 0.625rem; padding-right: 0.625rem; }
    .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .px-5 { padding-left: 1.25rem; padding-right: 1.25rem; }
    .py-0\.5 { padding-top: 0.125rem; padding-bottom: 0.125rem; }
    .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
    .py-1\.5 { padding-top: 0.375rem; padding-bottom: 0.375rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-16 { padding-top: 4rem; padding-bottom: 4rem; }
    .pt-2 { padding-top: 0.5rem; }
    .mb-0\.5 { margin-bottom: 0.125rem; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-3 { margin-bottom: 0.75rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-5 { margin-bottom: 1.25rem; }
    .ml-1 { margin-left: 0.25rem; }
    .ml-auto { margin-left: auto; }
    .mr-0\.5 { margin-right: 0.125rem; }
    .mt-1 { margin-top: 0.25rem; }
    .-mx-1\.5 { margin-left: -0.375rem; margin-right: -0.375rem; }

    /* Typography */
    .text-xs { font-size: 0.75rem; line-height: 1rem; }
    .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
    .text-base { font-size: 1rem; line-height: 1.5rem; }
    .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
    .font-mono { font-family: 'SF Mono', Consolas, Monaco, monospace; }
    .font-medium { font-weight: 500; }
    .font-semibold { font-weight: 600; }
    .uppercase { text-transform: uppercase; }
    .tracking-wide { letter-spacing: 0.025em; }
    .tracking-wider { letter-spacing: 0.05em; }
    .tracking-tight { letter-spacing: -0.025em; }
    .text-center { text-align: center; }
    .text-left { text-align: left; }
    .italic { font-style: italic; }
    .line-through { text-decoration: line-through; }
    .list-decimal { list-style-type: decimal; }
    .list-inside { list-style-position: inside; }

    /* Colors */
    .text-white { color: #fff; }
    .text-slate-300 { color: #cbd5e1; }
    .text-slate-400 { color: #94a3b8; }
    .text-slate-500 { color: #64748b; }
    .text-slate-600 { color: #475569; }
    .text-slate-700 { color: #334155; }
    .text-slate-800 { color: #1e293b; }
    .text-blue-200 { color: #bfdbfe; }
    .text-blue-600 { color: #2563eb; }
    .text-blue-700 { color: #1d4ed8; }
    .text-red-500 { color: #ef4444; }
    .text-red-600 { color: #dc2626; }
    .text-emerald-600 { color: #059669; }
    .text-emerald-700 { color: #047857; }
    .bg-white { background-color: #fff; }
    .bg-slate-50 { background-color: #f8fafc; }
    .bg-slate-100 { background-color: #f1f5f9; }
    .bg-slate-200 { background-color: #e2e8f0; }
    .bg-slate-300 { background-color: #cbd5e1; }
    .bg-slate-400 { background-color: #94a3b8; }
    .bg-slate-500 { background-color: #64748b; }
    .bg-slate-600 { background-color: #475569; }
    .bg-slate-700 { background-color: #334155; }
    .bg-slate-800 { background-color: #1e293b; }
    .bg-slate-900 { background-color: #0f172a; }
    .bg-blue-50 { background-color: #eff6ff; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-blue-700 { background-color: #1d4ed8; }
    .bg-red-50 { background-color: #fef2f2; }
    .bg-red-500 { background-color: #ef4444; }
    .bg-red-600 { background-color: #dc2626; }
    .bg-amber-400 { background-color: #fbbf24; }
    .bg-amber-500 { background-color: #f59e0b; }
    .bg-orange-500 { background-color: #f97316; }
    .bg-emerald-50 { background-color: #ecfdf5; }
    .bg-emerald-400 { background-color: #34d399; }
    .bg-transparent { background-color: transparent; }
    .placeholder-slate-400::placeholder { color: #94a3b8; }

    /* Borders */
    .border { border-width: 1px; border-style: solid; }
    .border-b { border-bottom-width: 1px; border-bottom-style: solid; }
    .border-r { border-right-width: 1px; border-right-style: solid; }
    .border-t { border-top-width: 1px; border-top-style: solid; }
    .border-slate-200 { border-color: #e2e8f0; }
    .border-slate-300 { border-color: #cbd5e1; }
    .border-slate-700 { border-color: #334155; }
    .border-blue-200 { border-color: #bfdbfe; }
    .border-blue-400 { border-color: #60a5fa; }
    .border-blue-500 { border-color: #3b82f6; }
    .border-emerald-200 { border-color: #a7f3d0; }
    .border-orange-200 { border-color: #fed7aa; }
    .border-amber-200 { border-color: #fde68a; }
    .border-inherit { border-color: inherit; }
    .rounded { border-radius: 0.25rem; }
    .rounded-md { border-radius: 0.375rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-full { border-radius: 9999px; }
    .rounded-t { border-top-left-radius: 0.25rem; border-top-right-radius: 0.25rem; }

    /* Effects */
    .shadow-lg { box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
    .shadow-xl { box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); }
    .opacity-0 { opacity: 0; }
    .opacity-50 { opacity: 0.5; }
    .outline-none { outline: none; }
    .cursor-pointer { cursor: pointer; }
    .cursor-grab { cursor: grab; }
    .cursor-not-allowed { cursor: not-allowed; }
    .resize-none { resize: none; }
    .transition-colors { transition-property: color, background-color, border-color; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
    .transition-opacity { transition-property: opacity; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
    .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
    .duration-150 { transition-duration: 150ms; }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    .transform { transform: translateX(var(--tw-translate-x, 0)) translateY(var(--tw-translate-y, 0)); }
    .-translate-x-1\/2 { --tw-translate-x: -50%; transform: translateX(-50%); }

    /* Interactive states */
    .hover\:bg-slate-50:hover { background-color: #f8fafc; }
    .hover\:bg-slate-100:hover { background-color: #f1f5f9; }
    .hover\:bg-slate-200:hover { background-color: #e2e8f0; }
    .hover\:bg-slate-300:hover { background-color: #cbd5e1; }
    .hover\:bg-slate-500:hover { background-color: #64748b; }
    .hover\:bg-slate-600:hover { background-color: #475569; }
    .hover\:bg-slate-700:hover { background-color: #334155; }
    .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
    .hover\:bg-red-50:hover { background-color: #fef2f2; }
    .hover\:bg-red-600:hover { background-color: #dc2626; }
    .hover\:bg-amber-400:hover { background-color: #fbbf24; }
    .hover\:text-white:hover { color: #fff; }
    .hover\:text-slate-200:hover { color: #e2e8f0; }
    .hover\:text-blue-700:hover { color: #1d4ed8; }
    .hover\:text-red-500:hover { color: #ef4444; }
    .group:hover .group-hover\:opacity-100 { opacity: 1; }
    .group\/st:hover .group-hover\/st\:opacity-100 { opacity: 1; }
    .focus\:ring-1:focus { box-shadow: 0 0 0 1px #3b82f6; }
    .focus\:ring-blue-400:focus { box-shadow: 0 0 0 2px #60a5fa; }
    .focus\:ring-blue-500:focus { box-shadow: 0 0 0 2px #3b82f6; }
    .focus\:border-blue-400:focus { border-color: #60a5fa; }
    .focus\:outline-none:focus { outline: none; }
    .disabled\:opacity-50:disabled { opacity: 0.5; }
    .disabled\:cursor-not-allowed:disabled { cursor: not-allowed; }

    /* Positioning */
    .relative { position: relative; }
    .fixed { position: fixed; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    .bottom-4 { bottom: 1rem; }
    .left-1\/2 { left: 50%; }
    .z-40 { z-index: 40; }
    .z-50 { z-index: 50; }

    /* Table */
    .border-collapse { border-collapse: collapse; }

    /* Custom colors with alpha */
    .bg-slate-900\/50 { background-color: rgb(15 23 42 / 0.5); }
    .bg-orange-50\/50 { background-color: rgb(255 247 237 / 0.5); }
    .bg-amber-50\/50 { background-color: rgb(255 251 235 / 0.5); }
    .bg-slate-50\/50 { background-color: rgb(248 250 252 / 0.5); }
    .bg-emerald-50\/50 { background-color: rgb(236 253 245 / 0.5); }
    .bg-orange-100\/50 { background-color: rgb(255 237 213 / 0.5); }
    .bg-amber-100\/50 { background-color: rgb(254 243 199 / 0.5); }
    .bg-slate-100\/50 { background-color: rgb(241 245 249 / 0.5); }
    .bg-emerald-100\/50 { background-color: rgb(209 250 229 / 0.5); }
    .bg-emerald-100\/30 { background-color: rgb(209 250 229 / 0.3); }

    /* Space utilities */
    .space-y-0\.5 > * + * { margin-top: 0.125rem; }
    .space-y-1 > * + * { margin-top: 0.25rem; }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-4 > * + * { margin-top: 1rem; }

    /* Group modifier */
    .group { position: relative; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const STORAGE_KEY = 'worklistData';
    const SETTINGS_KEY = 'worklistSettings';

    const defaultData = {
      tabs: ['Tasks'],
      tasks: { 'Tasks': [] }
    };

    const defaultSettings = {
      slackWebhook: ''
    };

    const statusConfig = {
      'pending': { label: 'Pending', color: 'bg-slate-100 text-slate-600 border border-slate-200' },
      'in-progress': { label: 'Active', color: 'bg-blue-50 text-blue-700 border border-blue-200' },
      'done': { label: 'Complete', color: 'bg-emerald-50 text-emerald-700 border border-emerald-200' },
    };

    const priorityConfig = {
      'low': { color: 'bg-slate-400', label: 'Low' },
      'medium': { color: 'bg-amber-400', label: 'Med' },
      'high': { color: 'bg-orange-500', label: 'High' },
    };

    const loadSavedData = () => {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.tabs && data.tasks) return data;
        }
      } catch (e) {}
      return defaultData;
    };

    const loadSettings = () => {
      try {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) return { ...defaultSettings, ...JSON.parse(saved) };
      } catch (e) {}
      return defaultSettings;
    };

    const useIsMobile = () => {
      const [isMobile, setIsMobile] = useState(window.innerWidth < 768);
      useEffect(() => {
        const handleResize = () => setIsMobile(window.innerWidth < 768);
        window.addEventListener('resize', handleResize);
        return () => window.removeEventListener('resize', handleResize);
      }, []);
      return isMobile;
    };

    // Icons
    const ChevronRight = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    );

    const ChevronDown = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    );

    const Plus = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = () => (
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Download = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
    );

    const Upload = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
    );

    const SlackIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
        <path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/>
      </svg>
    );

    const UndoIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <path d="M3 7v6h6"></path>
        <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"></path>
      </svg>
    );

    const GripIcon = () => (
      <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="9" cy="6" r="2"></circle>
        <circle cx="15" cy="6" r="2"></circle>
        <circle cx="9" cy="12" r="2"></circle>
        <circle cx="15" cy="12" r="2"></circle>
        <circle cx="9" cy="18" r="2"></circle>
        <circle cx="15" cy="18" r="2"></circle>
      </svg>
    );

    const ShareIcon = () => (
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"></path>
        <polyline points="16 6 12 2 8 6"></polyline>
        <line x1="12" y1="2" x2="12" y2="15"></line>
      </svg>
    );

    const Logo = () => (
      <svg width="28" height="28" viewBox="0 0 32 32" fill="none">
        <rect x="2" y="2" width="28" height="28" rx="4" fill="#3b82f6" />
        <path d="M8 10h16M8 16h12M8 22h14" stroke="white" strokeWidth="2.5" strokeLinecap="round" />
        <circle cx="24" cy="22" r="2" fill="white" />
      </svg>
    );

    function Worklist() {
      const savedData = loadSavedData();
      const [tabs, setTabs] = useState(savedData.tabs);
      const [activeTab, setActiveTab] = useState(savedData.tabs[0]);
      const [tasks, setTasks] = useState(savedData.tasks);
      const [expandedRows, setExpandedRows] = useState(new Set());
      const [editingTab, setEditingTab] = useState(null);
      const [deletingTab, setDeletingTab] = useState(null);
      const [saveStatus, setSaveStatus] = useState('saved');
      const [settings, setSettings] = useState(loadSettings());
      const [showSlackModal, setShowSlackModal] = useState(false);
      const [showShareModal, setShowShareModal] = useState(false);
      const [shareCategory, setShareCategory] = useState(null);
      const [slackStatus, setSlackStatus] = useState(null);
      const [undoStack, setUndoStack] = useState([]);
      const [showUndo, setShowUndo] = useState(false);
      const [draggedTab, setDraggedTab] = useState(null);
      const fileInputRef = useRef(null);
      const undoTimeoutRef = useRef(null);
      const isMobile = useIsMobile();

      // Auto-save data
      useEffect(() => {
        setSaveStatus('saving');
        const timeout = setTimeout(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ tabs, tasks }));
          setSaveStatus('saved');
        }, 800);
        return () => clearTimeout(timeout);
      }, [tabs, tasks]);

      // Save settings
      useEffect(() => {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }, [settings]);

      // Undo toast auto-hide
      useEffect(() => {
        if (showUndo) {
          undoTimeoutRef.current = setTimeout(() => {
            setShowUndo(false);
            setUndoStack([]);
          }, 5000);
        }
        return () => clearTimeout(undoTimeoutRef.current);
      }, [showUndo]);

      const pushUndo = (action) => {
        setUndoStack([action]);
        setShowUndo(true);
      };

      const performUndo = () => {
        if (undoStack.length === 0) return;
        const action = undoStack[0];
        
        if (action.type === 'deleteTask') {
          setTasks({
            ...tasks,
            [action.category]: [...(tasks[action.category] || []), action.task]
          });
        } else if (action.type === 'deleteSubtask') {
          setTasks({
            ...tasks,
            [action.category]: tasks[action.category].map(t =>
              t.id === action.taskId ? { ...t, subtasks: [...(t.subtasks || []), action.subtask] } : t
            )
          });
        }
        
        setShowUndo(false);
        setUndoStack([]);
      };

      const toggleRow = (id) => {
        const newExpanded = new Set(expandedRows);
        newExpanded.has(id) ? newExpanded.delete(id) : newExpanded.add(id);
        setExpandedRows(newExpanded);
      };

      const addTab = () => {
        const name = `Category ${tabs.length + 1}`;
        setTabs([...tabs, name]);
        setTasks({ ...tasks, [name]: [] });
        setActiveTab(name);
      };

      const closeTab = (tab) => {
        if (tabs.length === 1) return;
        const newTabs = tabs.filter(t => t !== tab);
        const newTasks = { ...tasks };
        delete newTasks[tab];
        setTabs(newTabs);
        setTasks(newTasks);
        if (activeTab === tab) setActiveTab(newTabs[0]);
        setDeletingTab(null);
      };

      const renameTab = (oldName, newName) => {
        if (!newName.trim() || newName === oldName) { setEditingTab(null); return; }
        const newTabs = tabs.map(t => t === oldName ? newName : t);
        const newTasks = { ...tasks, [newName]: tasks[oldName] };
        delete newTasks[oldName];
        setTabs(newTabs);
        setTasks(newTasks);
        if (activeTab === oldName) setActiveTab(newName);
        setEditingTab(null);
      };

      // Tab drag and drop
      const handleDragStart = (e, tab) => {
        setDraggedTab(tab);
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e, tab) => {
        e.preventDefault();
        if (draggedTab && draggedTab !== tab) {
          e.currentTarget.classList.add('drag-over');
        }
      };

      const handleDragLeave = (e) => {
        e.currentTarget.classList.remove('drag-over');
      };

      const handleDrop = (e, targetTab) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedTab || draggedTab === targetTab) return;
        
        const newTabs = [...tabs];
        const draggedIndex = newTabs.indexOf(draggedTab);
        const targetIndex = newTabs.indexOf(targetTab);
        
        newTabs.splice(draggedIndex, 1);
        newTabs.splice(targetIndex, 0, draggedTab);
        
        setTabs(newTabs);
        setDraggedTab(null);
      };

      const handleDragEnd = () => {
        setDraggedTab(null);
      };

      const addTask = () => {
        const newTask = {
          id: Date.now(),
          title: '',
          status: 'pending',
          priority: 'medium',
          due: new Date().toISOString().split('T')[0],
          details: '',
          subtasks: [],
        };
        setTasks({ ...tasks, [activeTab]: [...tasks[activeTab], newTask] });
        setExpandedRows(new Set([...expandedRows, newTask.id]));
      };

      const updateTask = (id, field, value) => {
        setTasks({
          ...tasks,
          [activeTab]: tasks[activeTab].map(t => t.id === id ? { ...t, [field]: value } : t),
        });
      };

      const deleteTask = (id) => {
        const task = tasks[activeTab].find(t => t.id === id);
        if (task) {
          pushUndo({ type: 'deleteTask', category: activeTab, task });
        }
        setTasks({ ...tasks, [activeTab]: tasks[activeTab].filter(t => t.id !== id) });
      };

      const addSubtask = (taskId) => {
        const newSubtask = { id: Date.now(), title: '', done: false };
        setTasks({
          ...tasks,
          [activeTab]: tasks[activeTab].map(t =>
            t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), newSubtask] } : t
          ),
        });
      };

      const updateSubtask = (taskId, subtaskId, field, value) => {
        setTasks({
          ...tasks,
          [activeTab]: tasks[activeTab].map(t =>
            t.id === taskId ? {
              ...t,
              subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, [field]: value } : st)
            } : t
          ),
        });
      };

      const deleteSubtask = (taskId, subtaskId) => {
        const task = tasks[activeTab].find(t => t.id === taskId);
        const subtask = task?.subtasks?.find(st => st.id === subtaskId);
        if (subtask) {
          pushUndo({ type: 'deleteSubtask', category: activeTab, taskId, subtask });
        }
        setTasks({
          ...tasks,
          [activeTab]: tasks[activeTab].map(t =>
            t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t
          ),
        });
      };

      const getSubtaskProgress = (task) => {
        const subtasks = task.subtasks || [];
        if (subtasks.length === 0) return null;
        return { done: subtasks.filter(st => st.done).length, total: subtasks.length };
      };

      const getAllTasksByPriority = () => {
        const allTasks = [];
        tabs.forEach(tab => {
          (tasks[tab] || []).forEach(task => allTasks.push({ ...task, category: tab }));
        });
        const priorityOrder = { high: 0, medium: 1, low: 2 };
        allTasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
        return {
          high: allTasks.filter(t => t.priority === 'high'),
          medium: allTasks.filter(t => t.priority === 'medium'),
          low: allTasks.filter(t => t.priority === 'low'),
        };
      };

      const updateTaskInCategory = (category, taskId, field, value) => {
        setTasks({
          ...tasks,
          [category]: tasks[category].map(t => t.id === taskId ? { ...t, [field]: value } : t),
        });
      };

      const deleteTaskInCategory = (category, taskId) => {
        const task = tasks[category].find(t => t.id === taskId);
        if (task) {
          pushUndo({ type: 'deleteTask', category, task });
        }
        setTasks({ ...tasks, [category]: tasks[category].filter(t => t.id !== taskId) });
      };

      const addSubtaskInCategory = (category, taskId) => {
        const newSubtask = { id: Date.now(), title: '', done: false };
        setTasks({
          ...tasks,
          [category]: tasks[category].map(t =>
            t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), newSubtask] } : t
          ),
        });
      };

      const updateSubtaskInCategory = (category, taskId, subtaskId, field, value) => {
        setTasks({
          ...tasks,
          [category]: tasks[category].map(t =>
            t.id === taskId ? {
              ...t,
              subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, [field]: value } : st)
            } : t
          ),
        });
      };

      const deleteSubtaskInCategory = (category, taskId, subtaskId) => {
        const task = tasks[category].find(t => t.id === taskId);
        const subtask = task?.subtasks?.find(st => st.id === subtaskId);
        if (subtask) {
          pushUndo({ type: 'deleteSubtask', category, taskId, subtask });
        }
        setTasks({
          ...tasks,
          [category]: tasks[category].map(t =>
            t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t
          ),
        });
      };

      const downloadSave = () => {
        const data = JSON.stringify({ tabs, tasks }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `worklist_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.tabs && data.tasks) {
              setTabs(data.tabs);
              setTasks(data.tasks);
              setActiveTab(data.tabs[0]);
              setExpandedRows(new Set());
              localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }
          } catch (err) {}
        };
        reader.readAsText(file);
        e.target.value = '';
      };

      // Slack integration
      const shareToSlack = async (category, options = {}) => {
        if (!settings.slackWebhook) {
          setShowSlackModal(true);
          return;
        }

        const categoryTasks = tasks[category] || [];
        const activeTasks = categoryTasks.filter(t => t.status !== 'done');
        const completedTasks = categoryTasks.filter(t => t.status === 'done');

        const priorityEmoji = { high: 'ðŸ”´', medium: 'ðŸŸ¡', low: 'âšª' };
        
        let blocks = [
          {
            type: 'header',
            text: { type: 'plain_text', text: `ðŸ“‹ Worklist: ${category}`, emoji: true }
          }
        ];

        ['high', 'medium', 'low'].forEach(priority => {
          const prioTasks = activeTasks.filter(t => t.priority === priority);
          if (prioTasks.length > 0) {
            const label = priority.charAt(0).toUpperCase() + priority.slice(1);
            let text = `*${priorityEmoji[priority]} ${label} Priority*\n`;
            prioTasks.forEach(t => {
              text += `â€¢ ${t.title || '(untitled)'}${t.due ? ` â€” Due: ${t.due}` : ''}\n`;
            });
            blocks.push({ type: 'section', text: { type: 'mrkdwn', text } });
          }
        });

        if (options.includeCompleted && completedTasks.length > 0) {
          let text = `*âœ… Completed*\n`;
          completedTasks.forEach(t => {
            text += `â€¢ ~${t.title || '(untitled)'}~\n`;
          });
          blocks.push({ type: 'section', text: { type: 'mrkdwn', text } });
        }

        blocks.push({
          type: 'context',
          elements: [{ type: 'mrkdwn', text: `${activeTasks.length} active â€¢ ${completedTasks.length} complete â€¢ Updated just now` }]
        });

        setSlackStatus('sending');
        try {
          await fetch(settings.slackWebhook, {
            method: 'POST',
            body: JSON.stringify({ blocks }),
          });
          setSlackStatus('success');
          setTimeout(() => {
            setSlackStatus(null);
            setShowShareModal(false);
          }, 2000);
        } catch (err) {
          setSlackStatus('error');
        }
      };

      const isPriorityView = activeTab === 'âš¡ Priority';
      const currentTasks = tasks[activeTab] || [];
      const activeTasks = currentTasks.filter(t => t.status !== 'done');
      const doneTasks = currentTasks.filter(t => t.status === 'done');

      const renderTaskRow = (task, isDone = false, forCategory = null) => {
        const isExpanded = expandedRows.has(task.id);
        const progress = getSubtaskProgress(task);
        const category = forCategory || activeTab;
        const updateFn = forCategory ? (id, f, v) => updateTaskInCategory(category, id, f, v) : updateTask;
        const deleteFn = forCategory ? (id) => deleteTaskInCategory(category, id) : deleteTask;
        const addSubFn = forCategory ? (id) => addSubtaskInCategory(category, id) : addSubtask;
        const updateSubFn = forCategory ? (tid, sid, f, v) => updateSubtaskInCategory(category, tid, sid, f, v) : updateSubtask;
        const deleteSubFn = forCategory ? (tid, sid) => deleteSubtaskInCategory(category, tid, sid) : deleteSubtask;

        return (
          <React.Fragment key={task.id}>
            <tr className={`border-b border-slate-200 hover:bg-slate-50 group transition-colors duration-150 ${isDone ? 'opacity-50' : ''}`}>
              <td className="px-2 py-1.5 border-r border-slate-200 text-center">
                <button onClick={() => toggleRow(task.id)} className="p-1 hover:bg-slate-200 rounded transition-colors duration-150 text-slate-500">
                  {isExpanded ? <ChevronDown /> : <ChevronRight />}
                </button>
              </td>
              <td className="px-2 py-1.5 border-r border-slate-200">
                <div className="flex items-center gap-2">
                  <input
                    value={task.title}
                    placeholder="Enter task..."
                    onChange={(e) => updateFn(task.id, 'title', e.target.value)}
                    className={`flex-1 bg-transparent outline-none text-sm placeholder-slate-400 ${isDone ? 'line-through text-slate-400' : 'text-slate-700'}`}
                  />
                  {progress && (
                    <span className="font-mono text-xs text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded">
                      {progress.done}/{progress.total}
                    </span>
                  )}
                </div>
              </td>
              {forCategory && (
                <td className="px-2 py-1.5 border-r border-slate-200">
                  <span className="font-mono text-xs px-1.5 py-0.5 rounded bg-slate-100 text-slate-600">{category}</span>
                </td>
              )}
              <td className="px-2 py-1.5 border-r border-slate-200">
                <select
                  value={task.status}
                  onChange={(e) => updateFn(task.id, 'status', e.target.value)}
                  className={`text-xs px-2 py-0.5 rounded ${statusConfig[task.status].color} outline-none cursor-pointer font-medium`}
                >
                  <option value="pending">Pending</option>
                  <option value="in-progress">Active</option>
                  <option value="done">Complete</option>
                </select>
              </td>
              {!forCategory && (
                <td className="px-2 py-1.5 border-r border-slate-200">
                  <div className="flex items-center gap-1.5">
                    <span className={`w-2 h-2 rounded-full ${priorityConfig[task.priority].color}`}></span>
                    <select
                      value={task.priority}
                      onChange={(e) => updateFn(task.id, 'priority', e.target.value)}
                      className="text-xs outline-none cursor-pointer bg-transparent text-slate-600"
                    >
                      <option value="low">Low</option>
                      <option value="medium">Med</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </td>
              )}
              <td className="px-2 py-1.5 border-r border-slate-200">
                <input
                  type="date"
                  value={task.due}
                  onChange={(e) => updateFn(task.id, 'due', e.target.value)}
                  className="font-mono text-xs bg-transparent outline-none text-slate-600"
                />
              </td>
              <td className="px-2 py-1.5 text-center">
                <button
                  onClick={() => deleteFn(task.id)}
                  className="p-1 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded opacity-0 group-hover:opacity-100 transition-all duration-150"
                >
                  <X />
                </button>
              </td>
            </tr>
            {isExpanded && (
              <tr className="bg-slate-50 border-b border-slate-200">
                <td className="border-r border-slate-200 bg-slate-100"></td>
                <td colSpan={forCategory ? 5 : 5} className="px-3 py-3">
                  <div className="mb-3">
                    <div className="flex items-center justify-between mb-2">
                      <button onClick={() => addSubFn(task.id)} className="text-xs text-blue-600 hover:text-blue-700 flex items-center gap-1 font-medium">
                        <Plus /> Add subtask
                      </button>
                      <span className="text-xs text-slate-400 uppercase tracking-wide">Subtasks</span>
                    </div>
                    {(task.subtasks || []).length === 0 ? (
                      <div className="text-xs text-slate-400 italic">No subtasks</div>
                    ) : (
                      <div className="space-y-0.5">
                        {(task.subtasks || []).map((st) => (
                          <div key={st.id} className="flex items-center gap-2 group/st p-1.5 -mx-1.5 rounded hover:bg-slate-100 transition-colors duration-150">
                            <input
                              type="checkbox"
                              checked={st.done}
                              onChange={(e) => updateSubFn(task.id, st.id, 'done', e.target.checked)}
                              className="w-3.5 h-3.5 cursor-pointer rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                            />
                            <input
                              value={st.title}
                              placeholder="Enter subtask..."
                              onChange={(e) => updateSubFn(task.id, st.id, 'title', e.target.value)}
                              className={`flex-1 text-sm bg-transparent outline-none placeholder-slate-400 ${st.done ? 'line-through text-slate-400' : 'text-slate-600'}`}
                            />
                            <button
                              onClick={() => deleteSubFn(task.id, st.id)}
                              className="p-0.5 text-slate-300 hover:text-red-500 opacity-0 group-hover/st:opacity-100 transition-all duration-150"
                            >
                              <X />
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  <div className="text-xs text-slate-400 uppercase tracking-wide mb-1">Notes</div>
                  <textarea
                    value={task.details}
                    placeholder="Add notes..."
                    onChange={(e) => updateFn(task.id, 'details', e.target.value)}
                    rows={2}
                    className="w-full p-2 text-sm border border-slate-200 rounded bg-white resize-none placeholder-slate-400 text-slate-600 focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                  />
                </td>
              </tr>
            )}
          </React.Fragment>
        );
      };

      const renderEmptyState = (message, showAdd = false) => (
        <div className="flex flex-col items-center justify-center py-16 text-center">
          <div className="w-16 h-16 mb-4 rounded-full bg-slate-100 flex items-center justify-center">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5">
              <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
              <path d="M9 12h6M9 16h6"/>
            </svg>
          </div>
          <p className="text-slate-500 text-sm mb-4">{message}</p>
          {showAdd && (
            <button
              onClick={addTask}
              className="flex items-center gap-1.5 px-4 py-2 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors duration-150 font-medium"
            >
              <Plus /> Add your first task
            </button>
          )}
        </div>
      );

      const renderPriorityContent = () => {
        const allTasks = Object.values(getAllTasksByPriority()).flat();
        if (allTasks.length === 0) {
          return renderEmptyState("No tasks yet. Create tasks in your categories to see them organized by priority.");
        }

        return (
          <div className="space-y-4">
            {['high', 'medium', 'low'].map(priority => {
              const prioTasks = getAllTasksByPriority()[priority].filter(t => t.status !== 'done');
              const colors = { 
                high: 'border-orange-200 bg-orange-50/50', 
                medium: 'border-amber-200 bg-amber-50/50', 
                low: 'border-slate-200 bg-slate-50/50' 
              };
              const headers = {
                high: 'border-orange-200 bg-orange-100/50',
                medium: 'border-amber-200 bg-amber-100/50',
                low: 'border-slate-200 bg-slate-100/50'
              };
              return (
                <div key={priority} className={`rounded-md border ${colors[priority]}`}>
                  <div className={`px-3 py-2 border-b ${headers[priority]} flex items-center justify-between`}>
                    <div className="flex items-center gap-2">
                      <span className={`w-2.5 h-2.5 rounded-full ${priorityConfig[priority].color}`}></span>
                      <span className="font-medium text-slate-700 text-sm">{priorityConfig[priority].label} Priority</span>
                    </div>
                    <span className="font-mono text-xs text-slate-400">{prioTasks.length}</span>
                  </div>
                  {prioTasks.length === 0 ? (
                    <div className="p-6 text-center text-slate-400 text-sm">No {priority} priority tasks</div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse text-sm" style={{minWidth: '500px'}}>
                        <thead>
                          <tr className="border-b border-inherit text-xs text-slate-500 uppercase tracking-wide">
                            <th className="w-8 p-2"></th>
                            <th className="text-left p-2 font-medium">Task</th>
                            <th className="text-left p-2 font-medium">Category</th>
                            <th className="text-left p-2 font-medium">Status</th>
                            <th className="text-left p-2 font-medium">Due</th>
                            <th className="w-8 p-2"></th>
                          </tr>
                        </thead>
                        <tbody>
                          {prioTasks.map(task => renderTaskRow(task, false, task.category))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              );
            })}
            {(() => {
              const allDone = Object.values(getAllTasksByPriority()).flat().filter(t => t.status === 'done');
              if (allDone.length === 0) return null;
              return (
                <div className="rounded-md border border-emerald-200 bg-emerald-50/50">
                  <div className="px-3 py-2 border-b border-emerald-200 bg-emerald-100/50 flex items-center justify-between">
                    <span className="font-medium text-slate-700 text-sm">âœ“ Complete</span>
                    <span className="font-mono text-xs text-slate-400">{allDone.length}</span>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse text-sm" style={{minWidth: '500px'}}>
                      <thead>
                        <tr className="border-b border-emerald-200 text-xs text-slate-500 uppercase tracking-wide">
                          <th className="w-8 p-2"></th>
                          <th className="text-left p-2 font-medium">Task</th>
                          <th className="text-left p-2 font-medium">Category</th>
                          <th className="text-left p-2 font-medium">Status</th>
                          <th className="text-left p-2 font-medium">Due</th>
                          <th className="w-8 p-2"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {allDone.map(task => renderTaskRow(task, true, task.category))}
                      </tbody>
                    </table>
                  </div>
                </div>
              );
            })()}
          </div>
        );
      };

      const renderTabContent = () => {
        if (currentTasks.length === 0) {
          return renderEmptyState("No tasks in this category yet.", true);
        }

        return (
          <div className="space-y-4">
            <div className="rounded-md border border-slate-200 bg-white">
              <div className="px-3 py-2 border-b border-slate-200 bg-slate-50 flex items-center justify-between">
                <span className="font-medium text-slate-700 text-sm">Active</span>
                <span className="font-mono text-xs text-slate-400">{activeTasks.length}</span>
              </div>
              {activeTasks.length === 0 ? (
                <div className="p-6 text-center text-slate-400 text-sm">No active tasks</div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse text-sm" style={{minWidth: '500px'}}>
                    <thead>
                      <tr className="border-b border-slate-200 text-xs text-slate-500 uppercase tracking-wide bg-slate-50">
                        <th className="w-8 px-2 py-2 border-r border-slate-200"></th>
                        <th className="text-left px-2 py-2 font-medium border-r border-slate-200">Task</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-slate-200">Status</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-slate-200">Priority</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-slate-200">Due</th>
                        <th className="w-8 px-2 py-2"></th>
                      </tr>
                    </thead>
                    <tbody>{activeTasks.map(t => renderTaskRow(t, false))}</tbody>
                  </table>
                </div>
              )}
            </div>

            {doneTasks.length > 0 && (
              <div className="rounded-md border border-emerald-200 bg-emerald-50/50">
                <div className="px-3 py-2 border-b border-emerald-200 bg-emerald-100/50 flex items-center justify-between">
                  <span className="font-medium text-slate-700 text-sm">âœ“ Complete</span>
                  <span className="font-mono text-xs text-slate-400">{doneTasks.length}</span>
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse text-sm" style={{minWidth: '500px'}}>
                    <thead>
                      <tr className="border-b border-emerald-200 text-xs text-slate-500 uppercase tracking-wide bg-emerald-100/30">
                        <th className="w-8 px-2 py-2 border-r border-emerald-200"></th>
                        <th className="text-left px-2 py-2 font-medium border-r border-emerald-200">Task</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-emerald-200">Status</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-emerald-200">Priority</th>
                        <th className="text-left px-2 py-2 font-medium border-r border-emerald-200">Due</th>
                        <th className="w-8 px-2 py-2"></th>
                      </tr>
                    </thead>
                    <tbody>{doneTasks.map(t => renderTaskRow(t, true))}</tbody>
                  </table>
                </div>
              </div>
            )}
          </div>
        );
      };

      // Modals
      const renderDeleteModal = () => deletingTab && (
        <>
          <div className="fixed inset-0 bg-slate-900/50 z-40" onClick={() => setDeletingTab(null)}></div>
          <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-md shadow-xl max-w-sm w-full p-5 border border-slate-200">
              <h3 className="text-base font-semibold text-slate-800 mb-1">Delete "{deletingTab}"?</h3>
              <p className="text-sm text-slate-500 mb-5">This will permanently delete {(tasks[deletingTab] || []).length} tasks.</p>
              <div className="flex gap-2">
                <button onClick={() => setDeletingTab(null)} className="flex-1 px-3 py-1.5 text-sm bg-slate-100 text-slate-700 rounded hover:bg-slate-200 transition-colors duration-150">Cancel</button>
                <button onClick={() => closeTab(deletingTab)} className="flex-1 px-3 py-1.5 text-sm bg-red-500 text-white rounded hover:bg-red-600 transition-colors duration-150">Delete</button>
              </div>
            </div>
          </div>
        </>
      );

      const renderSlackModal = () => showSlackModal && (
        <>
          <div className="fixed inset-0 bg-slate-900/50 z-40" onClick={() => setShowSlackModal(false)}></div>
          <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-md shadow-xl max-w-md w-full p-5 border border-slate-200">
              <h3 className="text-base font-semibold text-slate-800 mb-1 flex items-center gap-2">
                <SlackIcon /> Slack Integration
              </h3>
              <p className="text-sm text-slate-500 mb-4">Connect Worklist to share tasks to Slack channels.</p>
              
              <div className="mb-4">
                <label className="block text-xs font-medium text-slate-600 mb-1 uppercase tracking-wide">Webhook URL</label>
                <input
                  type="text"
                  value={settings.slackWebhook}
                  onChange={(e) => setSettings({ ...settings, slackWebhook: e.target.value })}
                  placeholder="https://hooks.slack.com/services/..."
                  className="w-full px-3 py-2 text-sm border border-slate-200 rounded focus:outline-none focus:border-blue-400 focus:ring-1 focus:ring-blue-400"
                />
              </div>

              <div className="bg-slate-50 rounded p-3 mb-4 text-xs text-slate-600">
                <div className="font-medium mb-2">How to get a Webhook URL:</div>
                <ol className="list-decimal list-inside space-y-1">
                  <li>Go to <span className="font-mono">api.slack.com/apps</span></li>
                  <li>Create New App â†’ From Scratch</li>
                  <li>Add "Incoming Webhooks" feature</li>
                  <li>Create webhook for your channel</li>
                  <li>Copy the URL and paste above</li>
                </ol>
              </div>

              <div className="flex gap-2">
                <button onClick={() => setShowSlackModal(false)} className="flex-1 px-3 py-1.5 text-sm bg-slate-100 text-slate-700 rounded hover:bg-slate-200 transition-colors duration-150">Cancel</button>
                <button 
                  onClick={() => setShowSlackModal(false)} 
                  disabled={!settings.slackWebhook}
                  className="flex-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors duration-150 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </>
      );

      const renderShareModal = () => showShareModal && shareCategory && (
        <>
          <div className="fixed inset-0 bg-slate-900/50 z-40" onClick={() => setShowShareModal(false)}></div>
          <div className="fixed inset-0 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-md shadow-xl max-w-sm w-full p-5 border border-slate-200">
              <h3 className="text-base font-semibold text-slate-800 mb-1 flex items-center gap-2">
                <ShareIcon /> Share to Slack
              </h3>
              <p className="text-sm text-slate-500 mb-4">
                Post {(tasks[shareCategory] || []).filter(t => t.status !== 'done').length} active tasks from "{shareCategory}" to Slack?
              </p>

              <div className="space-y-2 mb-4">
                <label className="flex items-center gap-2 text-sm text-slate-600">
                  <input type="checkbox" id="includeCompleted" className="rounded border-slate-300" />
                  <span>Include completed tasks</span>
                </label>
              </div>

              {slackStatus === 'error' && (
                <div className="bg-red-50 text-red-600 text-sm p-2 rounded mb-4">
                  Failed to send. Check your webhook URL.
                </div>
              )}

              {slackStatus === 'success' && (
                <div className="bg-emerald-50 text-emerald-600 text-sm p-2 rounded mb-4">
                  âœ“ Posted to Slack!
                </div>
              )}

              <div className="flex gap-2">
                <button onClick={() => { setShowShareModal(false); setSlackStatus(null); }} className="flex-1 px-3 py-1.5 text-sm bg-slate-100 text-slate-700 rounded hover:bg-slate-200 transition-colors duration-150">Cancel</button>
                <button 
                  onClick={() => shareToSlack(shareCategory, { includeCompleted: document.getElementById('includeCompleted')?.checked })}
                  disabled={slackStatus === 'sending'}
                  className="flex-1 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors duration-150 disabled:opacity-50 flex items-center justify-center gap-1"
                >
                  {slackStatus === 'sending' ? 'Sending...' : <><SlackIcon /> Post</>}
                </button>
              </div>
            </div>
          </div>
        </>
      );

      // Undo toast
      const renderUndoToast = () => showUndo && undoStack.length > 0 && (
        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-50 bg-slate-800 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-3">
          <span className="text-sm">
            {undoStack[0].type === 'deleteTask' ? 'Task deleted' : 'Subtask deleted'}
          </span>
          <button 
            onClick={performUndo}
            className="flex items-center gap-1 px-2 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm font-medium transition-colors"
          >
            <UndoIcon /> Undo
          </button>
          <button 
            onClick={() => { setShowUndo(false); setUndoStack([]); }}
            className="text-slate-400 hover:text-white"
          >
            <X />
          </button>
        </div>
      );

      // DESKTOP LAYOUT
      if (!isMobile) {
        return (
          <div className="h-screen flex bg-slate-100">
            <div className="w-52 bg-slate-800 flex flex-col">
              <div className="p-4 flex items-center gap-2.5">
                <Logo />
                <span className="font-semibold text-white tracking-tight">Worklist</span>
              </div>

              <div className="flex-1 overflow-y-auto px-2 py-1">
                <div className="text-xs font-medium text-slate-500 uppercase tracking-wider px-2 py-2">Categories</div>
                {tabs.map(tab => (
                  <div
                    key={tab}
                    draggable
                    onDragStart={(e) => handleDragStart(e, tab)}
                    onDragOver={(e) => handleDragOver(e, tab)}
                    onDragLeave={handleDragLeave}
                    onDrop={(e) => handleDrop(e, tab)}
                    onDragEnd={handleDragEnd}
                    onClick={() => setActiveTab(tab)}
                    onDoubleClick={() => setEditingTab(tab)}
                    className={`flex items-center justify-between px-2.5 py-1.5 rounded cursor-pointer mb-0.5 group transition-colors duration-150
                      ${activeTab === tab ? 'bg-blue-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}
                  >
                    {editingTab === tab ? (
                      <input
                        autoFocus
                        defaultValue={tab}
                        className="flex-1 px-1 text-sm bg-slate-900 border border-blue-500 rounded outline-none text-white"
                        onBlur={(e) => renameTab(tab, e.target.value)}
                        onKeyDown={(e) => {
                          if (e.key === 'Enter') renameTab(tab, e.target.value);
                          if (e.key === 'Escape') setEditingTab(null);
                        }}
                        onClick={(e) => e.stopPropagation()}
                      />
                    ) : (
                      <>
                        <div className="flex items-center gap-1.5">
                          <span className="text-slate-500 cursor-grab opacity-0 group-hover:opacity-100"><GripIcon /></span>
                          <span className="text-sm truncate">{tab}</span>
                        </div>
                        <div className="flex items-center gap-1">
                          <span className={`font-mono text-xs ${activeTab === tab ? 'text-blue-200' : 'text-slate-500'}`}>
                            {(tasks[tab] || []).length}
                          </span>
                          {tabs.length > 1 && (
                            <button
                              onClick={(e) => { e.stopPropagation(); setDeletingTab(tab); }}
                              className={`p-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-150 ${activeTab === tab ? 'hover:bg-blue-700 text-blue-200' : 'hover:bg-slate-600 text-slate-400'}`}
                            >
                              <X />
                            </button>
                          )}
                        </div>
                      </>
                    )}
                  </div>
                ))}
                <button
                  onClick={addTab}
                  className="flex items-center gap-1.5 px-2.5 py-1.5 text-sm text-slate-400 hover:text-slate-200 hover:bg-slate-700 rounded w-full mt-1 transition-colors duration-150"
                >
                  <Plus /> Add category
                </button>
              </div>

              <div className="px-2 py-2 border-t border-slate-700">
                <div
                  onClick={() => setActiveTab('âš¡ Priority')}
                  className={`flex items-center gap-2 px-2.5 py-1.5 rounded cursor-pointer transition-colors duration-150
                    ${isPriorityView ? 'bg-amber-500 text-white' : 'text-slate-300 hover:bg-slate-700'}`}
                >
                  <span className="text-sm">âš¡ All by Priority</span>
                </div>
              </div>

              <div className="p-3 border-t border-slate-700 space-y-2">
                <div className="flex items-center gap-1.5 text-xs text-slate-500">
                  <span className={`w-1.5 h-1.5 rounded-full ${saveStatus === 'saving' ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'}`}></span>
                  <span className="font-mono">{saveStatus === 'saving' ? 'SAVING' : 'SYNCED'}</span>
                </div>
                <div className="flex gap-1.5">
                  <button onClick={downloadSave} className="flex-1 text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded flex items-center justify-center gap-1 transition-colors duration-150">
                    <Download /> Export
                  </button>
                  <button onClick={() => fileInputRef.current?.click()} className="flex-1 text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded flex items-center justify-center gap-1 transition-colors duration-150">
                    <Upload /> Import
                  </button>
                </div>
                <button 
                  onClick={() => setShowSlackModal(true)} 
                  className="w-full text-xs px-2 py-1 bg-slate-700 hover:bg-slate-600 text-slate-300 rounded flex items-center justify-center gap-1 transition-colors duration-150"
                >
                  <SlackIcon /> {settings.slackWebhook ? 'Slack Connected' : 'Connect Slack'}
                </button>
                <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".json" className="hidden" />
              </div>
            </div>

            <div className="flex-1 flex flex-col overflow-hidden">
              <div className="bg-white border-b border-slate-200 px-5 py-3 flex items-center justify-between">
                <h1 className="text-lg font-semibold text-slate-800">
                  {isPriorityView ? 'âš¡ All Tasks by Priority' : activeTab}
                </h1>
                <div className="flex items-center gap-2">
                  {!isPriorityView && settings.slackWebhook && (
                    <button
                      onClick={() => { setShareCategory(activeTab); setShowShareModal(true); }}
                      className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-slate-100 text-slate-700 rounded hover:bg-slate-200 transition-colors duration-150"
                    >
                      <SlackIcon /> Share
                    </button>
                  )}
                  {!isPriorityView && (
                    <button
                      onClick={addTask}
                      className="flex items-center gap-1.5 px-3 py-1.5 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors duration-150 font-medium"
                    >
                      <Plus /> Add Task
                    </button>
                  )}
                </div>
              </div>

              <div className="flex-1 overflow-auto p-5 content-scroll">
                {isPriorityView ? renderPriorityContent() : renderTabContent()}
              </div>
            </div>

            {renderDeleteModal()}
            {renderSlackModal()}
            {renderShareModal()}
            {renderUndoToast()}
          </div>
        );
      }

      // MOBILE LAYOUT
      return (
        <div className="h-screen flex flex-col bg-slate-100">
          <div className="bg-slate-800 px-4 py-3 flex items-center gap-2.5">
            <Logo />
            <span className="font-semibold text-white tracking-tight">Worklist</span>
            <div className="ml-auto flex items-center gap-1.5 text-xs text-slate-400">
              <span className={`w-1.5 h-1.5 rounded-full ${saveStatus === 'saving' ? 'bg-amber-400' : 'bg-emerald-400'}`}></span>
              <span className="font-mono">{saveStatus === 'saving' ? 'SAVING' : 'SYNCED'}</span>
            </div>
          </div>

          <div className="bg-slate-700 flex items-end px-2 pt-2 overflow-x-auto">
            {tabs.map((tab, index) => (
              <div
                key={tab}
                draggable
                onDragStart={(e) => handleDragStart(e, tab)}
                onDragOver={(e) => handleDragOver(e, tab)}
                onDragLeave={handleDragLeave}
                onDrop={(e) => handleDrop(e, tab)}
                onDragEnd={handleDragEnd}
                onClick={() => setActiveTab(tab)}
                onDoubleClick={() => setEditingTab(tab)}
                className={`relative flex items-center gap-1.5 px-3 py-1.5 cursor-pointer rounded-t transition-colors duration-150 flex-shrink-0 mr-0.5
                  ${activeTab === tab ? 'bg-slate-100 text-slate-800' : 'bg-slate-600 text-slate-300 hover:bg-slate-500'}`}
              >
                {editingTab === tab ? (
                  <input
                    autoFocus
                    defaultValue={tab}
                    className="w-20 px-1 text-sm bg-white border border-blue-500 rounded outline-none"
                    onBlur={(e) => renameTab(tab, e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === 'Enter') renameTab(tab, e.target.value);
                      if (e.key === 'Escape') setEditingTab(null);
                    }}
                    onClick={(e) => e.stopPropagation()}
                  />
                ) : (
                  <>
                    <span className="text-sm max-w-20 truncate">{tab}</span>
                    <span className={`font-mono text-xs ${activeTab === tab ? 'text-slate-500' : 'text-slate-400'}`}>
                      {(tasks[tab] || []).length}
                    </span>
                  </>
                )}
                {tabs.length > 1 && activeTab === tab && (
                  <button
                    onClick={(e) => { e.stopPropagation(); setDeletingTab(tab); }}
                    className="p-0.5 rounded hover:bg-slate-200 text-slate-400"
                  >
                    <X />
                  </button>
                )}
              </div>
            ))}
            <button onClick={addTab} className="p-1.5 text-slate-400 hover:text-slate-200 hover:bg-slate-600 rounded-full ml-1 mb-1 flex-shrink-0">
              <Plus />
            </button>
            <div className="flex-1 min-w-3"></div>
            <div
              onClick={() => setActiveTab('âš¡ Priority')}
              className={`relative flex items-center gap-1 px-3 py-1.5 cursor-pointer rounded-t transition-colors duration-150 flex-shrink-0
                ${isPriorityView ? 'bg-slate-100 text-slate-800' : 'bg-amber-500 text-white hover:bg-amber-400'}`}
            >
              <span className="text-sm whitespace-nowrap">âš¡ Priority</span>
            </div>
          </div>

          <div className="bg-white border-b border-slate-200 px-3 py-2 flex items-center gap-2 flex-wrap">
            {!isPriorityView && (
              <button
                onClick={addTask}
                className="flex items-center gap-1 px-2.5 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
              >
                <Plus /> Add
              </button>
            )}
            {!isPriorityView && settings.slackWebhook && (
              <button 
                onClick={() => { setShareCategory(activeTab); setShowShareModal(true); }}
                className="flex items-center gap-1 px-2.5 py-1 text-sm bg-slate-200 text-slate-700 rounded hover:bg-slate-300"
              >
                <SlackIcon /> Share
              </button>
            )}
            <button onClick={downloadSave} className="flex items-center gap-1 px-2.5 py-1 text-sm bg-slate-600 text-white rounded hover:bg-slate-700">
              <Download /> Export
            </button>
            <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-1 px-2.5 py-1 text-sm bg-slate-600 text-white rounded hover:bg-slate-700">
              <Upload /> Import
            </button>
            <button onClick={() => setShowSlackModal(true)} className="flex items-center gap-1 px-2.5 py-1 text-sm bg-slate-600 text-white rounded hover:bg-slate-700">
              <SlackIcon />
            </button>
            <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".json" className="hidden" />
          </div>

          <div className="flex-1 overflow-auto p-3 content-scroll">
            {isPriorityView ? renderPriorityContent() : renderTabContent()}
          </div>

          <div className="bg-slate-800 px-4 py-2 text-xs text-slate-400 flex justify-between font-mono">
            <span>{isPriorityView ? `${Object.values(getAllTasksByPriority()).flat().length} TOTAL` : `${currentTasks.length} IN ${activeTab.toUpperCase()}`}</span>
            <span>OFFLINE READY</span>
          </div>

          {renderDeleteModal()}
          {renderSlackModal()}
          {renderShareModal()}
          {renderUndoToast()}
        </div>
      );
    }

    ReactDOM.render(<Worklist />, document.getElementById('root'));

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
