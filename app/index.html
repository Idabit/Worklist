<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline';">
  <title>Worklist â€” Offline-First Task Management</title>
  <script src="./react.production.min.js"></script>
  <script src="./react-dom.production.min.js"></script>
  <script src="./babel.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body, #root { height: 100%; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif; background: #f1f5f9; }
    
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .content-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
    .content-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; }
    .drag-over { background-color: #3b82f6 !important; opacity: 0.7; }

    .app-container { display: flex; height: 100vh; }
    .sidebar { width: 208px; background: #1e293b; display: flex; flex-direction: column; }
    .sidebar-header { padding: 16px; display: flex; align-items: center; gap: 10px; }
    .sidebar-header span { font-weight: 600; color: white; letter-spacing: -0.025em; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 4px 8px; }
    .sidebar-section-title { font-size: 12px; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; padding: 8px; }
    
    .tab-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 10px; border-radius: 4px; cursor: pointer; margin-bottom: 2px; transition: background-color 0.15s; }
    .tab-item:hover { background: #334155; }
    .tab-item.active { background: #2563eb; }
    .tab-item .tab-name { font-size: 14px; color: #cbd5e1; display: flex; align-items: center; gap: 6px; }
    .tab-item.active .tab-name { color: white; }
    .tab-item .tab-count { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; color: #64748b; }
    .tab-item.active .tab-count { color: #bfdbfe; }
    .tab-item .tab-close { padding: 2px; border-radius: 4px; opacity: 0; transition: opacity 0.15s; color: #94a3b8; background: none; border: none; cursor: pointer; }
    .tab-item:hover .tab-close { opacity: 1; }
    .tab-item .tab-close:hover { background: #475569; color: white; }
    .tab-item .grip { color: #64748b; cursor: grab; opacity: 0; }
    .tab-item:hover .grip { opacity: 1; }

    .add-category { display: flex; align-items: center; gap: 6px; padding: 6px 10px; font-size: 14px; color: #94a3b8; cursor: pointer; border-radius: 4px; transition: all 0.15s; background: none; border: none; width: 100%; text-align: left; margin-top: 4px; }
    .add-category:hover { color: #e2e8f0; background: #334155; }

    .priority-tab { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 4px; cursor: pointer; transition: background-color 0.15s; color: #cbd5e1; font-size: 14px; }
    .priority-tab:hover { background: #334155; }
    .priority-tab.active { background: #f59e0b; color: white; }

    .sidebar-footer { padding: 12px; border-top: 1px solid #334155; }
    .sync-status { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #64748b; margin-bottom: 8px; }
    .sync-dot { width: 6px; height: 6px; border-radius: 50%; }
    .sync-dot.saving { background: #fbbf24; animation: pulse 2s infinite; }
    .sync-dot.saved { background: #34d399; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .sidebar-buttons { display: flex; gap: 6px; margin-bottom: 8px; }
    .sidebar-btn { flex: 1; display: flex; align-items: center; justify-content: center; gap: 4px; padding: 4px 8px; font-size: 12px; background: #334155; color: #cbd5e1; border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.15s; }
    .sidebar-btn:hover { background: #475569; }
    .slack-btn { width: 100%; }

    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .main-header { background: white; border-bottom: 1px solid #e2e8f0; padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
    .main-header h1 { font-size: 18px; font-weight: 600; color: #1e293b; }
    .header-buttons { display: flex; gap: 8px; }
    
    .btn { display: flex; align-items: center; gap: 6px; padding: 6px 12px; font-size: 14px; border-radius: 4px; cursor: pointer; transition: all 0.15s; border: none; font-weight: 500; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: #f1f5f9; color: #334155; }
    .btn-secondary:hover { background: #e2e8f0; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }

    .main-body { flex: 1; overflow: auto; padding: 20px; }

    .task-section { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 16px; }
    .task-section.done { background: rgb(236 253 245 / 0.5); border-color: #a7f3d0; }
    .section-header { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; background: #f8fafc; display: flex; align-items: center; justify-content: space-between; border-radius: 6px 6px 0 0; }
    .task-section.done .section-header { background: rgb(209 250 229 / 0.5); border-color: #a7f3d0; }
    .section-title { font-size: 14px; font-weight: 500; color: #334155; }
    .section-count { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; color: #94a3b8; }

    .task-table { width: 100%; border-collapse: collapse; }
    .task-table th { text-align: left; padding: 8px; font-size: 12px; font-weight: 500; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; background: #f8fafc; }
    .task-section.done .task-table th { background: rgb(209 250 229 / 0.3); border-color: #a7f3d0; }
    .task-table td { padding: 6px 8px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
    .task-section.done .task-table td { border-color: #a7f3d0; }
    .task-row { transition: background-color 0.15s; }
    .task-row:hover { background: #f8fafc; }
    .task-row.done { opacity: 0.5; }

    .expand-btn { padding: 4px; background: none; border: none; cursor: pointer; color: #64748b; border-radius: 4px; transition: background-color 0.15s; }
    .expand-btn:hover { background: #e2e8f0; }

    .task-input { flex: 1; background: transparent; border: none; outline: none; font-size: 14px; color: #334155; }
    .task-input::placeholder { color: #94a3b8; }
    .task-input.done { text-decoration: line-through; color: #94a3b8; }

    .task-title-cell { display: flex; align-items: center; gap: 8px; }
    .subtask-badge { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; color: #94a3b8; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }

    .status-select { font-size: 12px; padding: 2px 8px; border-radius: 4px; border: 1px solid; outline: none; cursor: pointer; font-weight: 500; }
    .status-pending { background: #f1f5f9; color: #475569; border-color: #e2e8f0; }
    .status-in-progress { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
    .status-done { background: #ecfdf5; color: #047857; border-color: #a7f3d0; }

    .priority-cell { display: flex; align-items: center; gap: 6px; }
    .priority-dot { width: 8px; height: 8px; border-radius: 50%; }
    .priority-dot.low { background: #94a3b8; }
    .priority-dot.medium { background: #fbbf24; }
    .priority-dot.high { background: #f97316; }
    .priority-select { font-size: 12px; background: transparent; border: none; outline: none; cursor: pointer; color: #475569; }

    .date-input { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; background: transparent; border: none; outline: none; color: #475569; }

    .delete-btn { padding: 4px; background: none; border: none; cursor: pointer; color: #cbd5e1; border-radius: 4px; opacity: 0; transition: all 0.15s; }
    .task-row:hover .delete-btn { opacity: 1; }
    .delete-btn:hover { color: #ef4444; background: #fef2f2; }

    .expanded-row { background: #f8fafc; }
    .expanded-row td { padding: 12px; }
    .expanded-content { padding-left: 8px; }

    .subtask-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .add-subtask-btn { display: flex; align-items: center; gap: 4px; font-size: 12px; color: #2563eb; background: none; border: none; cursor: pointer; font-weight: 500; }
    .add-subtask-btn:hover { color: #1d4ed8; }
    .subtask-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; }

    .subtask-item { display: flex; align-items: center; gap: 8px; padding: 6px; margin: 0 -6px; border-radius: 4px; transition: background-color 0.15s; }
    .subtask-item:hover { background: #f1f5f9; }
    .subtask-checkbox { width: 14px; height: 14px; cursor: pointer; }
    .subtask-input { flex: 1; background: transparent; border: none; outline: none; font-size: 14px; color: #475569; }
    .subtask-input::placeholder { color: #94a3b8; }
    .subtask-input.done { text-decoration: line-through; color: #94a3b8; }
    .subtask-delete { padding: 2px; background: none; border: none; cursor: pointer; color: #cbd5e1; opacity: 0; transition: opacity 0.15s; }
    .subtask-item:hover .subtask-delete { opacity: 1; }
    .subtask-delete:hover { color: #ef4444; }

    .notes-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin: 12px 0 4px; }
    .notes-input { width: 100%; padding: 8px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 4px; resize: none; outline: none; color: #475569; }
    .notes-input::placeholder { color: #94a3b8; }
    .notes-input:focus { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); }

    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 64px 20px; text-align: center; }
    .empty-icon { width: 64px; height: 64px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .empty-text { color: #64748b; font-size: 14px; margin-bottom: 16px; }
    .no-subtasks { font-size: 12px; color: #94a3b8; font-style: italic; }

    .priority-section { background: white; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 16px; }
    .priority-section.high { border-color: #fed7aa; background: rgb(255 247 237 / 0.5); }
    .priority-section.medium { border-color: #fde68a; background: rgb(255 251 235 / 0.5); }
    .priority-section.low { border-color: #e2e8f0; background: rgb(248 250 252 / 0.5); }
    .priority-section.complete { border-color: #a7f3d0; background: rgb(236 253 245 / 0.5); }
    .priority-section .section-header { border-radius: 6px 6px 0 0; }
    .priority-section.high .section-header { background: rgb(255 237 213 / 0.5); border-color: #fed7aa; }
    .priority-section.medium .section-header { background: rgb(254 243 199 / 0.5); border-color: #fde68a; }
    .priority-section.low .section-header { background: rgb(241 245 249 / 0.5); border-color: #e2e8f0; }
    .priority-section.complete .section-header { background: rgb(209 250 229 / 0.5); border-color: #a7f3d0; }
    .priority-section .task-table th { background: transparent; }

    .category-badge { font-family: 'SF Mono', Consolas, monospace; font-size: 12px; padding: 2px 6px; background: #f1f5f9; color: #475569; border-radius: 4px; }

    .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.5); z-index: 40; display: flex; align-items: center; justify-content: center; padding: 16px; }
    .modal { background: white; border-radius: 6px; box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); max-width: 400px; width: 100%; padding: 20px; border: 1px solid #e2e8f0; }
    .modal-title { font-size: 16px; font-weight: 600; color: #1e293b; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .modal-text { font-size: 14px; color: #64748b; margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 8px; }
    .modal-buttons .btn { flex: 1; justify-content: center; }

    .modal-input { width: 100%; padding: 8px 12px; font-size: 14px; border: 1px solid #e2e8f0; border-radius: 4px; outline: none; margin-bottom: 16px; }
    .modal-input:focus { border-color: #60a5fa; box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2); }
    .modal-input::placeholder { color: #94a3b8; }

    .modal-label { font-size: 12px; font-weight: 500; color: #475569; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px; display: block; }
    .modal-help { background: #f8fafc; border-radius: 4px; padding: 12px; margin-bottom: 16px; }
    .modal-help-title { font-size: 12px; font-weight: 500; color: #334155; margin-bottom: 8px; }
    .modal-help ol { font-size: 12px; color: #475569; padding-left: 16px; }
    .modal-help li { margin-bottom: 4px; }

    .checkbox-label { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #475569; margin-bottom: 16px; }
    .checkbox-label input { width: 16px; height: 16px; }

    .alert { padding: 8px 12px; border-radius: 4px; font-size: 14px; margin-bottom: 16px; }
    .alert-error { background: #fef2f2; color: #dc2626; }
    .alert-success { background: #ecfdf5; color: #059669; }

    .undo-toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); z-index: 50; background: #1e293b; color: white; padding: 8px 16px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); display: flex; align-items: center; gap: 12px; }
    .undo-toast span { font-size: 14px; }
    .undo-btn { display: flex; align-items: center; gap: 4px; padding: 4px 8px; background: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .undo-btn:hover { background: #1d4ed8; }
    .undo-close { padding: 4px; background: none; border: none; cursor: pointer; color: #94a3b8; }
    .undo-close:hover { color: white; }

    .tab-input { flex: 1; padding: 2px 4px; font-size: 14px; background: #0f172a; border: 1px solid #3b82f6; border-radius: 4px; outline: none; color: white; }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const STORAGE_KEY = 'worklistData';
    const SETTINGS_KEY = 'worklistSettings';

    const defaultData = { tabs: ['Tasks'], tasks: { 'Tasks': [] } };
    const defaultSettings = { slackWebhook: '' };

    const loadSavedData = () => {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const data = JSON.parse(saved);
          if (data.tabs && data.tasks) return data;
        }
      } catch (e) {}
      return defaultData;
    };

    const loadSettings = () => {
      try {
        const saved = localStorage.getItem(SETTINGS_KEY);
        if (saved) return { ...defaultSettings, ...JSON.parse(saved) };
      } catch (e) {}
      return defaultSettings;
    };

    // Icons
    const ChevronRight = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="9 18 15 12 9 6"/></svg>;
    const ChevronDown = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><polyline points="6 9 12 15 18 9"/></svg>;
    const Plus = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
    const X = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
    const Download = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
    const Upload = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>;
    const SlackIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5.042 15.165a2.528 2.528 0 0 1-2.52 2.523A2.528 2.528 0 0 1 0 15.165a2.527 2.527 0 0 1 2.522-2.52h2.52v2.52zM6.313 15.165a2.527 2.527 0 0 1 2.521-2.52 2.527 2.527 0 0 1 2.521 2.52v6.313A2.528 2.528 0 0 1 8.834 24a2.528 2.528 0 0 1-2.521-2.522v-6.313zM8.834 5.042a2.528 2.528 0 0 1-2.521-2.52A2.528 2.528 0 0 1 8.834 0a2.528 2.528 0 0 1 2.521 2.522v2.52H8.834zM8.834 6.313a2.528 2.528 0 0 1 2.521 2.521 2.528 2.528 0 0 1-2.521 2.521H2.522A2.528 2.528 0 0 1 0 8.834a2.528 2.528 0 0 1 2.522-2.521h6.312zM18.956 8.834a2.528 2.528 0 0 1 2.522-2.521A2.528 2.528 0 0 1 24 8.834a2.528 2.528 0 0 1-2.522 2.521h-2.522V8.834zM17.688 8.834a2.528 2.528 0 0 1-2.523 2.521 2.527 2.527 0 0 1-2.52-2.521V2.522A2.527 2.527 0 0 1 15.165 0a2.528 2.528 0 0 1 2.523 2.522v6.312zM15.165 18.956a2.528 2.528 0 0 1 2.523 2.522A2.528 2.528 0 0 1 15.165 24a2.527 2.527 0 0 1-2.52-2.522v-2.522h2.52zM15.165 17.688a2.527 2.527 0 0 1-2.52-2.523 2.526 2.526 0 0 1 2.52-2.52h6.313A2.527 2.527 0 0 1 24 15.165a2.528 2.528 0 0 1-2.522 2.523h-6.313z"/></svg>;
    const UndoIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13"/></svg>;
    const GripIcon = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="9" cy="6" r="2"/><circle cx="15" cy="6" r="2"/><circle cx="9" cy="12" r="2"/><circle cx="15" cy="12" r="2"/><circle cx="9" cy="18" r="2"/><circle cx="15" cy="18" r="2"/></svg>;
    const ShareIcon = () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>;
    const Logo = () => <svg width="28" height="28" viewBox="0 0 32 32" fill="none"><rect x="2" y="2" width="28" height="28" rx="4" fill="#3b82f6"/><path d="M8 10h16M8 16h12M8 22h14" stroke="white" strokeWidth="2.5" strokeLinecap="round"/><circle cx="24" cy="22" r="2" fill="white"/></svg>;
    const ClipboardIcon = () => <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/><path d="M9 12h6M9 16h6"/></svg>;

    function Worklist() {
      const savedData = loadSavedData();
      const [tabs, setTabs] = useState(savedData.tabs);
      const [activeTab, setActiveTab] = useState(savedData.tabs[0]);
      const [tasks, setTasks] = useState(savedData.tasks);
      const [expandedRows, setExpandedRows] = useState(new Set());
      const [editingTab, setEditingTab] = useState(null);
      const [deletingTab, setDeletingTab] = useState(null);
      const [saveStatus, setSaveStatus] = useState('saved');
      const [settings, setSettings] = useState(loadSettings());
      const [showSlackModal, setShowSlackModal] = useState(false);
      const [showShareModal, setShowShareModal] = useState(false);
      const [shareCategory, setShareCategory] = useState(null);
      const [slackStatus, setSlackStatus] = useState(null);
      const [undoStack, setUndoStack] = useState([]);
      const [showUndo, setShowUndo] = useState(false);
      const [draggedTab, setDraggedTab] = useState(null);
      const fileInputRef = useRef(null);
      const undoTimeoutRef = useRef(null);

      useEffect(() => {
        setSaveStatus('saving');
        const timeout = setTimeout(() => {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ tabs, tasks }));
          setSaveStatus('saved');
        }, 800);
        return () => clearTimeout(timeout);
      }, [tabs, tasks]);

      useEffect(() => {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }, [settings]);

      useEffect(() => {
        if (showUndo) {
          undoTimeoutRef.current = setTimeout(() => { setShowUndo(false); setUndoStack([]); }, 5000);
        }
        return () => clearTimeout(undoTimeoutRef.current);
      }, [showUndo]);

      const pushUndo = (action) => { setUndoStack([action]); setShowUndo(true); };

      const performUndo = () => {
        if (undoStack.length === 0) return;
        const action = undoStack[0];
        if (action.type === 'deleteTask') {
          setTasks({ ...tasks, [action.category]: [...(tasks[action.category] || []), action.task] });
        } else if (action.type === 'deleteSubtask') {
          setTasks({ ...tasks, [action.category]: tasks[action.category].map(t => t.id === action.taskId ? { ...t, subtasks: [...(t.subtasks || []), action.subtask] } : t) });
        }
        setShowUndo(false);
        setUndoStack([]);
      };

      const toggleRow = (id) => {
        const newExpanded = new Set(expandedRows);
        newExpanded.has(id) ? newExpanded.delete(id) : newExpanded.add(id);
        setExpandedRows(newExpanded);
      };

      const addTab = () => {
        const name = `Category ${tabs.length + 1}`;
        setTabs([...tabs, name]);
        setTasks({ ...tasks, [name]: [] });
        setActiveTab(name);
      };

      const closeTab = (tab) => {
        if (tabs.length === 1) return;
        const newTabs = tabs.filter(t => t !== tab);
        const newTasks = { ...tasks };
        delete newTasks[tab];
        setTabs(newTabs);
        setTasks(newTasks);
        if (activeTab === tab) setActiveTab(newTabs[0]);
        setDeletingTab(null);
      };

      const renameTab = (oldName, newName) => {
        if (!newName.trim() || newName === oldName) { setEditingTab(null); return; }
        const newTabs = tabs.map(t => t === oldName ? newName : t);
        const newTasks = { ...tasks, [newName]: tasks[oldName] };
        delete newTasks[oldName];
        setTabs(newTabs);
        setTasks(newTasks);
        if (activeTab === oldName) setActiveTab(newName);
        setEditingTab(null);
      };

      const handleDragStart = (e, tab) => { setDraggedTab(tab); e.dataTransfer.effectAllowed = 'move'; };
      const handleDragOver = (e, tab) => { e.preventDefault(); if (draggedTab && draggedTab !== tab) e.currentTarget.classList.add('drag-over'); };
      const handleDragLeave = (e) => { e.currentTarget.classList.remove('drag-over'); };
      const handleDrop = (e, targetTab) => {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');
        if (!draggedTab || draggedTab === targetTab) return;
        const newTabs = [...tabs];
        const draggedIndex = newTabs.indexOf(draggedTab);
        const targetIndex = newTabs.indexOf(targetTab);
        newTabs.splice(draggedIndex, 1);
        newTabs.splice(targetIndex, 0, draggedTab);
        setTabs(newTabs);
        setDraggedTab(null);
      };
      const handleDragEnd = () => { setDraggedTab(null); };

      const addTask = () => {
        const newTask = { id: Date.now(), title: '', status: 'pending', priority: 'medium', due: new Date().toISOString().split('T')[0], details: '', subtasks: [] };
        setTasks({ ...tasks, [activeTab]: [...tasks[activeTab], newTask] });
        setExpandedRows(new Set([...expandedRows, newTask.id]));
      };

      const updateTask = (id, field, value) => { setTasks({ ...tasks, [activeTab]: tasks[activeTab].map(t => t.id === id ? { ...t, [field]: value } : t) }); };
      const deleteTask = (id) => {
        const task = tasks[activeTab].find(t => t.id === id);
        if (task) pushUndo({ type: 'deleteTask', category: activeTab, task });
        setTasks({ ...tasks, [activeTab]: tasks[activeTab].filter(t => t.id !== id) });
      };

      const addSubtask = (taskId) => {
        const newSubtask = { id: Date.now(), title: '', done: false };
        setTasks({ ...tasks, [activeTab]: tasks[activeTab].map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), newSubtask] } : t) });
      };
      const updateSubtask = (taskId, subtaskId, field, value) => { setTasks({ ...tasks, [activeTab]: tasks[activeTab].map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, [field]: value } : st) } : t) }); };
      const deleteSubtask = (taskId, subtaskId) => {
        const task = tasks[activeTab].find(t => t.id === taskId);
        const subtask = task?.subtasks?.find(st => st.id === subtaskId);
        if (subtask) pushUndo({ type: 'deleteSubtask', category: activeTab, taskId, subtask });
        setTasks({ ...tasks, [activeTab]: tasks[activeTab].map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t) });
      };

      const getSubtaskProgress = (task) => {
        const subtasks = task.subtasks || [];
        if (subtasks.length === 0) return null;
        return { done: subtasks.filter(st => st.done).length, total: subtasks.length };
      };

      const getAllTasksByPriority = () => {
        const allTasks = [];
        tabs.forEach(tab => { (tasks[tab] || []).forEach(task => allTasks.push({ ...task, category: tab })); });
        return { high: allTasks.filter(t => t.priority === 'high'), medium: allTasks.filter(t => t.priority === 'medium'), low: allTasks.filter(t => t.priority === 'low') };
      };

      const updateTaskInCategory = (category, taskId, field, value) => { setTasks({ ...tasks, [category]: tasks[category].map(t => t.id === taskId ? { ...t, [field]: value } : t) }); };
      const deleteTaskInCategory = (category, taskId) => {
        const task = tasks[category].find(t => t.id === taskId);
        if (task) pushUndo({ type: 'deleteTask', category, task });
        setTasks({ ...tasks, [category]: tasks[category].filter(t => t.id !== taskId) });
      };
      const addSubtaskInCategory = (category, taskId) => {
        const newSubtask = { id: Date.now(), title: '', done: false };
        setTasks({ ...tasks, [category]: tasks[category].map(t => t.id === taskId ? { ...t, subtasks: [...(t.subtasks || []), newSubtask] } : t) });
      };
      const updateSubtaskInCategory = (category, taskId, subtaskId, field, value) => { setTasks({ ...tasks, [category]: tasks[category].map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).map(st => st.id === subtaskId ? { ...st, [field]: value } : st) } : t) }); };
      const deleteSubtaskInCategory = (category, taskId, subtaskId) => {
        const task = tasks[category].find(t => t.id === taskId);
        const subtask = task?.subtasks?.find(st => st.id === subtaskId);
        if (subtask) pushUndo({ type: 'deleteSubtask', category, taskId, subtask });
        setTasks({ ...tasks, [category]: tasks[category].map(t => t.id === taskId ? { ...t, subtasks: (t.subtasks || []).filter(st => st.id !== subtaskId) } : t) });
      };

      const downloadSave = () => {
        const data = JSON.stringify({ tabs, tasks }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `worklist_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.tabs && data.tasks) {
              setTabs(data.tabs);
              setTasks(data.tasks);
              setActiveTab(data.tabs[0]);
              setExpandedRows(new Set());
              localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }
          } catch (err) {}
        };
        reader.readAsText(file);
        e.target.value = '';
      };

      const shareToSlack = async (category, options = {}) => {
        if (!settings.slackWebhook) { setShowSlackModal(true); return; }
        const categoryTasks = tasks[category] || [];
        const activeTasks = categoryTasks.filter(t => t.status !== 'done');
        const completedTasks = categoryTasks.filter(t => t.status === 'done');
        const priorityEmoji = { high: 'ðŸ”´', medium: 'ðŸŸ¡', low: 'âšª' };
        let blocks = [{ type: 'header', text: { type: 'plain_text', text: `ðŸ“‹ Worklist: ${category}`, emoji: true } }];
        ['high', 'medium', 'low'].forEach(priority => {
          const prioTasks = activeTasks.filter(t => t.priority === priority);
          if (prioTasks.length > 0) {
            const label = priority.charAt(0).toUpperCase() + priority.slice(1);
            let text = `*${priorityEmoji[priority]} ${label} Priority*\n`;
            prioTasks.forEach(t => { text += `â€¢ ${t.title || '(untitled)'}${t.due ? ` â€” Due: ${t.due}` : ''}\n`; });
            blocks.push({ type: 'section', text: { type: 'mrkdwn', text } });
          }
        });
        if (options.includeCompleted && completedTasks.length > 0) {
          let text = `*âœ… Completed*\n`;
          completedTasks.forEach(t => { text += `â€¢ ~${t.title || '(untitled)'}~\n`; });
          blocks.push({ type: 'section', text: { type: 'mrkdwn', text } });
        }
        blocks.push({ type: 'context', elements: [{ type: 'mrkdwn', text: `${activeTasks.length} active â€¢ ${completedTasks.length} complete â€¢ Updated just now` }] });
        setSlackStatus('sending');
        try {
          await fetch(settings.slackWebhook, { method: 'POST', body: JSON.stringify({ blocks }) });
          setSlackStatus('success');
          setTimeout(() => { setSlackStatus(null); setShowShareModal(false); }, 2000);
        } catch (err) { setSlackStatus('error'); }
      };

      const isPriorityView = activeTab === 'âš¡ Priority';
      const currentTasks = tasks[activeTab] || [];
      const activeTasks = currentTasks.filter(t => t.status !== 'done');
      const doneTasks = currentTasks.filter(t => t.status === 'done');

      const renderTaskRow = (task, isDone = false, forCategory = null) => {
        const isExpanded = expandedRows.has(task.id);
        const progress = getSubtaskProgress(task);
        const category = forCategory || activeTab;
        const updateFn = forCategory ? (id, f, v) => updateTaskInCategory(category, id, f, v) : updateTask;
        const deleteFn = forCategory ? (id) => deleteTaskInCategory(category, id) : deleteTask;
        const addSubFn = forCategory ? (id) => addSubtaskInCategory(category, id) : addSubtask;
        const updateSubFn = forCategory ? (tid, sid, f, v) => updateSubtaskInCategory(category, tid, sid, f, v) : updateSubtask;
        const deleteSubFn = forCategory ? (tid, sid) => deleteSubtaskInCategory(category, tid, sid) : deleteSubtask;

        return (
          <React.Fragment key={task.id}>
            <tr className={`task-row ${isDone ? 'done' : ''}`}>
              <td style={{width: '40px', textAlign: 'center'}}>
                <button className="expand-btn" onClick={() => toggleRow(task.id)}>
                  {isExpanded ? <ChevronDown /> : <ChevronRight />}
                </button>
              </td>
              <td>
                <div className="task-title-cell">
                  <input className={`task-input ${isDone ? 'done' : ''}`} value={task.title} placeholder="Enter task..." onChange={(e) => updateFn(task.id, 'title', e.target.value)} />
                  {progress && <span className="subtask-badge">{progress.done}/{progress.total}</span>}
                </div>
              </td>
              {forCategory && <td><span className="category-badge">{category}</span></td>}
              <td style={{width: '120px'}}>
                <select className={`status-select status-${task.status}`} value={task.status} onChange={(e) => updateFn(task.id, 'status', e.target.value)}>
                  <option value="pending">Pending</option>
                  <option value="in-progress">Active</option>
                  <option value="done">Complete</option>
                </select>
              </td>
              {!forCategory && (
                <td style={{width: '100px'}}>
                  <div className="priority-cell">
                    <span className={`priority-dot ${task.priority}`}></span>
                    <select className="priority-select" value={task.priority} onChange={(e) => updateFn(task.id, 'priority', e.target.value)}>
                      <option value="low">Low</option>
                      <option value="medium">Med</option>
                      <option value="high">High</option>
                    </select>
                  </div>
                </td>
              )}
              <td style={{width: '130px'}}>
                <input type="date" className="date-input" value={task.due} onChange={(e) => updateFn(task.id, 'due', e.target.value)} />
              </td>
              <td style={{width: '40px', textAlign: 'center'}}>
                <button className="delete-btn" onClick={() => deleteFn(task.id)}><X /></button>
              </td>
            </tr>
            {isExpanded && (
              <tr className="expanded-row">
                <td></td>
                <td colSpan={forCategory ? 5 : 5}>
                  <div className="expanded-content">
                    <div className="subtask-header">
                      <button className="add-subtask-btn" onClick={() => addSubFn(task.id)}><Plus /> Add subtask</button>
                      <span className="subtask-label">Subtasks</span>
                    </div>
                    {(task.subtasks || []).length === 0 ? (
                      <div className="no-subtasks">No subtasks</div>
                    ) : (
                      <div>
                        {(task.subtasks || []).map((st) => (
                          <div key={st.id} className="subtask-item">
                            <input type="checkbox" className="subtask-checkbox" checked={st.done} onChange={(e) => updateSubFn(task.id, st.id, 'done', e.target.checked)} />
                            <input className={`subtask-input ${st.done ? 'done' : ''}`} value={st.title} placeholder="Enter subtask..." onChange={(e) => updateSubFn(task.id, st.id, 'title', e.target.value)} />
                            <button className="subtask-delete" onClick={() => deleteSubFn(task.id, st.id)}><X /></button>
                          </div>
                        ))}
                      </div>
                    )}
                    <div className="notes-label">Notes</div>
                    <textarea className="notes-input" value={task.details} placeholder="Add notes..." onChange={(e) => updateFn(task.id, 'details', e.target.value)} rows={2} />
                  </div>
                </td>
              </tr>
            )}
          </React.Fragment>
        );
      };

      const renderEmptyState = (message, showAdd = false) => (
        <div className="empty-state">
          <div className="empty-icon"><ClipboardIcon /></div>
          <p className="empty-text">{message}</p>
          {showAdd && <button className="btn btn-primary" onClick={addTask}><Plus /> Add your first task</button>}
        </div>
      );

      const renderPriorityContent = () => {
        const allTasks = Object.values(getAllTasksByPriority()).flat();
        if (allTasks.length === 0) return renderEmptyState("No tasks yet. Create tasks in your categories to see them organized by priority.");
        const priorityLabels = { high: 'High Priority', medium: 'Medium Priority', low: 'Low Priority' };
        return (
          <div>
            {['high', 'medium', 'low'].map(priority => {
              const prioTasks = getAllTasksByPriority()[priority].filter(t => t.status !== 'done');
              return (
                <div key={priority} className={`priority-section ${priority}`}>
                  <div className="section-header">
                    <div className="section-title" style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                      <span className={`priority-dot ${priority}`}></span>
                      {priorityLabels[priority]}
                    </div>
                    <span className="section-count">{prioTasks.length}</span>
                  </div>
                  {prioTasks.length === 0 ? (
                    <div style={{padding: '24px', textAlign: 'center', color: '#94a3b8', fontSize: '14px'}}>No {priority} priority tasks</div>
                  ) : (
                    <table className="task-table">
                      <thead>
                        <tr>
                          <th style={{width: '40px'}}></th>
                          <th>Task</th>
                          <th>Category</th>
                          <th>Status</th>
                          <th>Due</th>
                          <th style={{width: '40px'}}></th>
                        </tr>
                      </thead>
                      <tbody>{prioTasks.map(task => renderTaskRow(task, false, task.category))}</tbody>
                    </table>
                  )}
                </div>
              );
            })}
            {(() => {
              const allDone = Object.values(getAllTasksByPriority()).flat().filter(t => t.status === 'done');
              if (allDone.length === 0) return null;
              return (
                <div className="priority-section complete">
                  <div className="section-header">
                    <span className="section-title">âœ“ Complete</span>
                    <span className="section-count">{allDone.length}</span>
                  </div>
                  <table className="task-table">
                    <thead><tr><th style={{width: '40px'}}></th><th>Task</th><th>Category</th><th>Status</th><th>Due</th><th style={{width: '40px'}}></th></tr></thead>
                    <tbody>{allDone.map(task => renderTaskRow(task, true, task.category))}</tbody>
                  </table>
                </div>
              );
            })()}
          </div>
        );
      };

      const renderTabContent = () => {
        if (currentTasks.length === 0) return renderEmptyState("No tasks in this category yet.", true);
        return (
          <div>
            <div className="task-section">
              <div className="section-header">
                <span className="section-title">Active</span>
                <span className="section-count">{activeTasks.length}</span>
              </div>
              {activeTasks.length === 0 ? (
                <div style={{padding: '24px', textAlign: 'center', color: '#94a3b8', fontSize: '14px'}}>No active tasks</div>
              ) : (
                <table className="task-table">
                  <thead><tr><th style={{width: '40px'}}></th><th>Task</th><th>Status</th><th>Priority</th><th>Due</th><th style={{width: '40px'}}></th></tr></thead>
                  <tbody>{activeTasks.map(t => renderTaskRow(t, false))}</tbody>
                </table>
              )}
            </div>
            {doneTasks.length > 0 && (
              <div className="task-section done">
                <div className="section-header">
                  <span className="section-title">âœ“ Complete</span>
                  <span className="section-count">{doneTasks.length}</span>
                </div>
                <table className="task-table">
                  <thead><tr><th style={{width: '40px'}}></th><th>Task</th><th>Status</th><th>Priority</th><th>Due</th><th style={{width: '40px'}}></th></tr></thead>
                  <tbody>{doneTasks.map(t => renderTaskRow(t, true))}</tbody>
                </table>
              </div>
            )}
          </div>
        );
      };

      return (
        <div className="app-container">
          <div className="sidebar">
            <div className="sidebar-header">
              <Logo />
              <span>Worklist</span>
            </div>
            <div className="sidebar-content">
              <div className="sidebar-section-title">Categories</div>
              {tabs.map(tab => (
                <div key={tab} className={`tab-item ${activeTab === tab ? 'active' : ''}`} draggable onDragStart={(e) => handleDragStart(e, tab)} onDragOver={(e) => handleDragOver(e, tab)} onDragLeave={handleDragLeave} onDrop={(e) => handleDrop(e, tab)} onDragEnd={handleDragEnd} onClick={() => setActiveTab(tab)} onDoubleClick={() => setEditingTab(tab)}>
                  {editingTab === tab ? (
                    <input className="tab-input" autoFocus defaultValue={tab} onBlur={(e) => renameTab(tab, e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') renameTab(tab, e.target.value); if (e.key === 'Escape') setEditingTab(null); }} onClick={(e) => e.stopPropagation()} />
                  ) : (
                    <>
                      <span className="tab-name"><span className="grip"><GripIcon /></span>{tab}</span>
                      <div style={{display: 'flex', alignItems: 'center', gap: '4px'}}>
                        <span className="tab-count">{(tasks[tab] || []).length}</span>
                        {tabs.length > 1 && <button className="tab-close" onClick={(e) => { e.stopPropagation(); setDeletingTab(tab); }}><X /></button>}
                      </div>
                    </>
                  )}
                </div>
              ))}
              <button className="add-category" onClick={addTab}><Plus /> Add category</button>
            </div>
            <div style={{padding: '8px', borderTop: '1px solid #334155'}}>
              <div className={`priority-tab ${isPriorityView ? 'active' : ''}`} onClick={() => setActiveTab('âš¡ Priority')}>âš¡ All by Priority</div>
            </div>
            <div className="sidebar-footer">
              <div className="sync-status">
                <span className={`sync-dot ${saveStatus === 'saving' ? 'saving' : 'saved'}`}></span>
                <span style={{fontFamily: 'monospace'}}>{saveStatus === 'saving' ? 'SAVING' : 'SYNCED'}</span>
              </div>
              <div className="sidebar-buttons">
                <button className="sidebar-btn" onClick={downloadSave}><Download /> Export</button>
                <button className="sidebar-btn" onClick={() => fileInputRef.current?.click()}><Upload /> Import</button>
              </div>
              <button className="sidebar-btn slack-btn" onClick={() => setShowSlackModal(true)}><SlackIcon /> {settings.slackWebhook ? 'Slack Connected' : 'Connect Slack'}</button>
              <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".json" className="hidden" />
            </div>
          </div>

          <div className="main-content">
            <div className="main-header">
              <h1>{isPriorityView ? 'âš¡ All Tasks by Priority' : activeTab}</h1>
              <div className="header-buttons">
                {!isPriorityView && settings.slackWebhook && <button className="btn btn-secondary" onClick={() => { setShareCategory(activeTab); setShowShareModal(true); }}><SlackIcon /> Share</button>}
                {!isPriorityView && <button className="btn btn-primary" onClick={addTask}><Plus /> Add Task</button>}
              </div>
            </div>
            <div className="main-body content-scroll">
              {isPriorityView ? renderPriorityContent() : renderTabContent()}
            </div>
          </div>

          {deletingTab && (
            <div className="modal-overlay" onClick={() => setDeletingTab(null)}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-title">Delete "{deletingTab}"?</div>
                <p className="modal-text">This will permanently delete {(tasks[deletingTab] || []).length} tasks.</p>
                <div className="modal-buttons">
                  <button className="btn btn-secondary" onClick={() => setDeletingTab(null)}>Cancel</button>
                  <button className="btn btn-danger" onClick={() => closeTab(deletingTab)}>Delete</button>
                </div>
              </div>
            </div>
          )}

          {showSlackModal && (
            <div className="modal-overlay" onClick={() => setShowSlackModal(false)}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-title"><SlackIcon /> Slack Integration</div>
                <p className="modal-text">Connect Worklist to share tasks to Slack channels.</p>
                <label className="modal-label">Webhook URL</label>
                <input className="modal-input" type="text" value={settings.slackWebhook} onChange={(e) => setSettings({ ...settings, slackWebhook: e.target.value })} placeholder="https://hooks.slack.com/services/..." />
                <div className="modal-help">
                  <div className="modal-help-title">How to get a Webhook URL:</div>
                  <ol>
                    <li>Go to api.slack.com/apps</li>
                    <li>Create New App â†’ From Scratch</li>
                    <li>Add "Incoming Webhooks" feature</li>
                    <li>Create webhook for your channel</li>
                    <li>Copy the URL and paste above</li>
                  </ol>
                </div>
                <div className="modal-buttons">
                  <button className="btn btn-secondary" onClick={() => setShowSlackModal(false)}>Cancel</button>
                  <button className="btn btn-primary" onClick={() => setShowSlackModal(false)} disabled={!settings.slackWebhook}>Save</button>
                </div>
              </div>
            </div>
          )}

          {showShareModal && shareCategory && (
            <div className="modal-overlay" onClick={() => setShowShareModal(false)}>
              <div className="modal" onClick={(e) => e.stopPropagation()}>
                <div className="modal-title"><ShareIcon /> Share to Slack</div>
                <p className="modal-text">Post {(tasks[shareCategory] || []).filter(t => t.status !== 'done').length} active tasks from "{shareCategory}" to Slack?</p>
                <label className="checkbox-label"><input type="checkbox" id="includeCompleted" /> Include completed tasks</label>
                {slackStatus === 'error' && <div className="alert alert-error">Failed to send. Check your webhook URL.</div>}
                {slackStatus === 'success' && <div className="alert alert-success">âœ“ Posted to Slack!</div>}
                <div className="modal-buttons">
                  <button className="btn btn-secondary" onClick={() => { setShowShareModal(false); setSlackStatus(null); }}>Cancel</button>
                  <button className="btn btn-primary" onClick={() => shareToSlack(shareCategory, { includeCompleted: document.getElementById('includeCompleted')?.checked })} disabled={slackStatus === 'sending'}>{slackStatus === 'sending' ? 'Sending...' : <><SlackIcon /> Post</>}</button>
                </div>
              </div>
            </div>
          )}

          {showUndo && undoStack.length > 0 && (
            <div className="undo-toast">
              <span>{undoStack[0].type === 'deleteTask' ? 'Task deleted' : 'Subtask deleted'}</span>
              <button className="undo-btn" onClick={performUndo}><UndoIcon /> Undo</button>
              <button className="undo-close" onClick={() => { setShowUndo(false); setUndoStack([]); }}><X /></button>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<Worklist />, document.getElementById('root'));
  </script>
</body>
</html>
